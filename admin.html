<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ĞĞ´Ğ¼Ğ¸Ğ½ â€” Ğ“Ğ¾ÑÑ‚Ğ¸ Ğ”ĞµĞ½Ğ¸Ñ & Ğ›ĞµĞ½Ğ°</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Dancing+Script:wght@600;700&display=swap" rel="stylesheet">
<style>
:root {
  --g1: #0d2218; --g2: #1b3a2d; --g3: #2a5540; --g4: #3d7a5a;
  --pale: #a8c5b5; --cream: #f4ede0; --cream2: #ede3d0;
  --gold: #c9a84c; --text: #152018; --text2: #2e4a38;
  --red: #c0392b; --red-light: #fdf0ee;
  --green-chip: #eaf4ef; --green-text: #1b5e38;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Montserrat',sans-serif;background:radial-gradient(ellipse 70% 50% at 80% 0%,#2a554020 0%,transparent 60%),radial-gradient(ellipse 60% 60% at 0% 100%,#1b3a2d15 0%,transparent 60%),var(--cream);min-height:100vh;color:var(--text)}

/* â”€â”€ SCREENS â”€â”€ */
.screen{display:none}
.screen.active{display:block}
#screenLogin{min-height:100vh;display:none;align-items:center;justify-content:center;padding:20px}
#screenLogin.active{display:flex}

/* â”€â”€ CARD â”€â”€ */
.card{background:#fff;border-radius:20px;padding:clamp(32px,6vw,52px) clamp(24px,5vw,44px);max-width:440px;width:100%;box-shadow:0 24px 64px rgba(13,34,24,.12);border:1px solid rgba(168,197,181,.3)}
.card-center{text-align:center}
.logo{font-family:'Dancing Script',cursive;font-size:36px;color:var(--g2);margin-bottom:4px}
.logo-sub{font-size:11px;letter-spacing:3px;text-transform:uppercase;color:var(--text2);opacity:.6;margin-bottom:32px}

.field-label{display:block;font-size:10px;letter-spacing:2.5px;text-transform:uppercase;font-weight:700;color:var(--g2);margin-bottom:8px}
.field-hint{font-size:11px;color:var(--text2);opacity:.55;margin-bottom:10px;line-height:1.5}
.field-input{width:100%;padding:12px 14px;border:1.5px solid var(--pale);border-radius:10px;font-family:'Montserrat',sans-serif;font-size:14px;color:var(--text);background:var(--cream);outline:none;transition:border-color .2s;-webkit-appearance:none;margin-bottom:18px}
.field-input:focus{border-color:var(--g3);box-shadow:0 0 0 3px rgba(42,85,64,.08)}
.field-input.mono{font-family:monospace;font-size:13px;letter-spacing:.5px}

.btn-full{width:100%;padding:14px;border-radius:10px;font-family:'Montserrat',sans-serif;font-size:12px;letter-spacing:3px;text-transform:uppercase;font-weight:700;cursor:pointer;border:none;transition:all .25s;margin-top:4px}
.btn-primary{background:var(--g2);color:#fff}
.btn-primary:hover{background:var(--g3);transform:translateY(-1px);box-shadow:0 6px 20px rgba(27,58,45,.25)}
.btn-primary:disabled{opacity:.5;transform:none;cursor:not-allowed}

.error-msg{color:var(--red);font-size:12px;margin:8px 0;display:none;line-height:1.5}
.error-msg.show{display:block}

.step-note{margin-top:20px;padding:14px 16px;background:rgba(168,197,181,.1);border:1px solid rgba(168,197,181,.3);border-radius:10px;font-size:12px;color:var(--text2);line-height:1.7}
.step-note strong{color:var(--g2)}
.step-note a{color:var(--g3);text-decoration:none;font-weight:600}
.step-note a:hover{text-decoration:underline}

/* â”€â”€ APP HEADER â”€â”€ */
#screenApp{display:none}
#screenApp.active{display:block}
.app-header{background:radial-gradient(ellipse 80% 80% at 20% 0%,#3d7a5a 0%,transparent 55%),radial-gradient(ellipse 60% 60% at 80% 100%,#2a5540 0%,transparent 50%),var(--g2);color:#fff;padding:20px clamp(16px,5vw,40px);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;position:sticky;top:0;z-index:100}
.header-left h1{font-family:'Dancing Script',cursive;font-size:clamp(20px,5vw,28px);line-height:1;margin-bottom:2px}
.header-left p{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--pale);opacity:.8}
.header-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 16px;border-radius:8px;font-family:'Montserrat',sans-serif;font-size:11px;letter-spacing:2px;text-transform:uppercase;font-weight:700;cursor:pointer;border:none;transition:all .2s;white-space:nowrap}
.btn-outline{background:transparent;border:1.5px solid rgba(255,255,255,.25);color:#fff}
.btn-outline:hover{background:rgba(255,255,255,.1)}
.btn-white{background:#fff;color:var(--g2)}
.btn-white:hover{background:var(--cream)}
.btn-sm-red{background:rgba(192,57,43,.15);border:1.5px solid rgba(192,57,43,.3);color:#fff}
.btn-sm-red:hover{background:rgba(192,57,43,.3)}

/* loading */
.loading-bar{height:3px;background:linear-gradient(90deg,var(--g3),var(--pale));animation:lb 1.2s ease-in-out infinite alternate;display:none}
.loading-bar.show{display:block}
@keyframes lb{from{opacity:.3}to{opacity:1}}

/* stats */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;padding:clamp(16px,4vw,28px) clamp(16px,5vw,40px);max-width:1100px;margin:0 auto}
.stat-card{background:#fff;border-radius:14px;padding:18px 20px;border:1px solid rgba(168,197,181,.25);box-shadow:0 4px 16px rgba(13,34,24,.06)}
.stat-num{font-size:clamp(26px,5vw,36px);font-weight:800;color:var(--g2);line-height:1;margin-bottom:4px}
.stat-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--text2);opacity:.6;font-weight:600}

/* netlify source banner */
.source-banner{background:linear-gradient(135deg,#f0f9f4,#e8f5ee);border:1.5px solid #a8c5b5;border-radius:12px;padding:10px 16px;margin:0 clamp(16px,5vw,40px) 14px;max-width:1100px;margin-left:auto;margin-right:auto;font-size:12px;color:var(--g2);display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
.source-banner span{opacity:.8}
.source-banner a{color:var(--g3);font-weight:600;text-decoration:none;font-size:11px}
.source-banner a:hover{text-decoration:underline}

/* controls */
.controls-bar{padding:0 clamp(16px,5vw,40px) 16px;max-width:1100px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.search-box{flex:1;min-width:160px;padding:10px 14px;border:1.5px solid var(--pale);border-radius:10px;font-family:'Montserrat',sans-serif;font-size:14px;color:var(--text);background:#fff;outline:none;transition:border-color .2s}
.search-box:focus{border-color:var(--g3)}
.filter-btn{padding:10px 16px;border-radius:10px;border:1.5px solid var(--pale);background:#fff;font-family:'Montserrat',sans-serif;font-size:12px;font-weight:600;color:var(--text2);cursor:pointer;transition:all .2s;white-space:nowrap}
.filter-btn:hover,.filter-btn.active{background:var(--g2);border-color:var(--g2);color:#fff}

/* table */
.table-wrap{padding:0 clamp(16px,5vw,40px) 60px;max-width:1100px;margin:0 auto;overflow-x:auto}
.guests-table{width:100%;border-collapse:separate;border-spacing:0 8px;min-width:640px}
.guests-table thead th{font-size:10px;letter-spacing:2.5px;text-transform:uppercase;font-weight:700;color:var(--text2);opacity:.55;padding:0 14px 6px;text-align:left}
.guests-table tbody tr{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(13,34,24,.05);transition:box-shadow .2s,transform .15s}
.guests-table tbody tr:hover{box-shadow:0 6px 20px rgba(13,34,24,.1);transform:translateY(-1px)}
.guests-table tbody td{padding:13px 14px;font-size:14px;vertical-align:middle}
.guests-table tbody td:first-child{border-radius:12px 0 0 12px}
.guests-table tbody td:last-child{border-radius:0 12px 12px 0}
.td-name{font-weight:700;color:var(--g2)}
.td-ts{font-size:11px;color:var(--text2);opacity:.55}

.chip{display:inline-block;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.5px}
.chip-yes{background:var(--green-chip);color:var(--green-text)}
.chip-no{background:var(--red-light);color:var(--red)}
.chip-food{background:rgba(201,168,76,.12);color:#7a5e10}
.drinks-list{font-size:12px;color:var(--text2);line-height:1.7;max-width:180px}

.btn-del{width:28px;height:28px;border-radius:7px;border:none;background:rgba(192,57,43,.08);color:var(--red);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.btn-del:hover{background:var(--red);color:#fff}

.empty-state{text-align:center;padding:60px 20px;color:var(--text2);opacity:.5}
.empty-state p{font-size:15px;font-weight:500;margin-top:12px}

/* mobile cards */
@media(max-width:640px){
  .table-wrap{padding:0 16px 60px;overflow-x:visible}
  .guests-table{display:none}
  .mobile-cards{display:flex;flex-direction:column;gap:10px}
}
@media(min-width:641px){.mobile-cards{display:none}}

.m-card{background:#fff;border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(13,34,24,.07);position:relative}
.m-card-name{font-weight:700;color:var(--g2);font-size:15px;margin-bottom:10px;padding-right:36px}
.m-card-row{display:flex;align-items:flex-start;gap:10px;margin-bottom:6px;font-size:13px}
.m-card-key{font-size:10px;letter-spacing:1.5px;text-transform:uppercase;font-weight:700;color:var(--text2);opacity:.5;min-width:70px;margin-top:2px}
.m-card-ts{font-size:11px;color:var(--text2);opacity:.45;margin-top:8px}
.m-card-del{position:absolute;top:14px;right:14px;width:30px;height:30px;border-radius:8px;border:none;background:rgba(192,57,43,.08);color:var(--red);cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:all .2s}
.m-card-del:hover{background:var(--red);color:#fff}

/* confirm */
.overlay{position:fixed;inset:0;z-index:9999;background:rgba(9,26,18,.6);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.open{opacity:1;pointer-events:all}
.confirm-box{background:#fff;border-radius:18px;padding:36px 32px;max-width:380px;width:100%;box-shadow:0 24px 64px rgba(9,26,18,.2);text-align:center;transform:scale(.94);transition:transform .2s}
.overlay.open .confirm-box{transform:scale(1)}
.confirm-icon{font-size:36px;margin-bottom:14px}
.confirm-title{font-size:18px;font-weight:800;color:var(--g2);margin-bottom:8px}
.confirm-msg{font-size:14px;color:var(--text2);line-height:1.6;margin-bottom:24px}
.confirm-btns{display:flex;gap:10px}
.confirm-btns button{flex:1;padding:13px;border-radius:10px;font-family:'Montserrat',sans-serif;font-size:12px;letter-spacing:2px;text-transform:uppercase;font-weight:700;cursor:pointer;border:none;transition:all .2s}
.cbtn-cancel{background:var(--cream);color:var(--text2)}
.cbtn-cancel:hover{background:var(--cream2)}
.cbtn-ok{background:var(--red);color:#fff}
.cbtn-ok:hover{background:#a93226}
</style>
</head>
<body>

<!-- â•â• LOGIN SCREEN â•â• -->
<div id="screenLogin" class="screen active">
  <div class="card card-center">
    <div class="logo">Ğ”ĞµĞ½Ğ¸Ñ & Ğ›ĞµĞ½Ğ°</div>
    <div class="logo-sub">Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Â· Ğ³Ğ¾ÑÑ‚Ğ¸</div>

    <label class="field-label" for="pwd">ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ</label>
    <input class="field-input" type="password" id="pwd" placeholder="Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ" autocomplete="current-password">
    <div class="error-msg" id="loginErr">ĞĞµĞ²ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ</div>
    <button class="btn-full btn-primary" onclick="tryLogin()">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ â†’</button>
  </div>
</div>

<!-- â•â• SETUP SCREEN â•â• -->
<div id="screenSetup" class="screen">
  <div style="min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px">
    <div class="card" style="max-width:520px">
      <div class="logo" style="text-align:center">ĞŸĞµÑ€Ğ²Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°</div>
      <div class="logo-sub" style="text-align:center">Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Netlify</div>

      <label class="field-label">Personal Access Token</label>
      <div class="field-hint">
        ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ <a href="https://app.netlify.com/user/applications#personal-access-tokens" target="_blank">netlify.com â†’ User settings â†’ Applications</a> â†’ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ Â«New access tokenÂ» â†’ ÑĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ ÑÑĞ´Ğ°.
      </div>
      <input class="field-input mono" type="password" id="setupToken" placeholder="nfp_xxxxxxxxxxxxxxxxxxxx">

      <label class="field-label">Site ID (Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ°Ğ¹Ñ‚Ğ°)</label>
      <div class="field-hint">
        ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ²Ğ°Ñˆ ÑĞ°Ğ¹Ñ‚ Ğ½Ğ° Netlify â†’ <strong>Site settings â†’ General</strong> â†’ ÑĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Â«Site IDÂ» (Ğ²Ñ‹Ğ³Ğ»ÑĞ´Ğ¸Ñ‚ ĞºĞ°Ğº <code>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx</code>).
      </div>
      <input class="field-input mono" id="setupSiteId" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx">

      <div class="error-msg" id="setupErr"></div>
      <button class="btn-full btn-primary" id="setupBtn" onclick="doSetup()">ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¸ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ â†’</button>

      <div class="step-note">
        ğŸ’¡ Ğ¢Ğ¾ĞºĞµĞ½ Ğ¸ Site ID ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑÑ‚ÑÑ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ â€” Ğ²Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾. Ğ”Ğ»Ñ Ğ´Ñ€ÑƒĞ³Ğ¾Ğ³Ğ¾ ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ²Ğ° Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ±ÑƒĞ´ĞµÑ‚ Ğ²Ğ²ĞµÑÑ‚Ğ¸ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· ÑĞ½Ğ¾Ğ²Ğ°.
      </div>
    </div>
  </div>
</div>

<!-- â•â• APP SCREEN â•â• -->
<div id="screenApp" class="screen">

  <header class="app-header">
    <div class="header-left">
      <h1>ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ³Ğ¾ÑÑ‚ĞµĞ¹</h1>
      <p>Netlify Forms Â· 01.08.2026</p>
    </div>
    <div class="header-actions">
      <button class="btn btn-outline" onclick="exportCSV()">â¬‡ CSV</button>
      <button class="btn btn-outline" onclick="loadGuests()">â†» ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ</button>
      <button class="btn btn-sm-red" onclick="clearSetup()">âš™ Ğ¡Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½</button>
      <button class="btn btn-white" onclick="logout()">Ğ’Ñ‹Ğ¹Ñ‚Ğ¸</button>
    </div>
  </header>

  <div class="loading-bar" id="loadingBar"></div>

  <div class="stats-row">
    <div class="stat-card"><div class="stat-num" id="st-total">â€”</div><div class="stat-label">Ğ²ÑĞµĞ³Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ¾Ğ²</div></div>
    <div class="stat-card"><div class="stat-num" id="st-yes">â€”</div><div class="stat-label">Ğ¿Ñ€Ğ¸Ğ´ÑƒÑ‚</div></div>
    <div class="stat-card"><div class="stat-num" id="st-no">â€”</div><div class="stat-label">Ğ½Ğµ ÑĞ¼Ğ¾Ğ³ÑƒÑ‚</div></div>
    <div class="stat-card"><div class="stat-num" id="st-bird">â€”</div><div class="stat-label">Ğ¿Ñ‚Ğ¸Ñ†Ğ°</div></div>
    <div class="stat-card"><div class="stat-num" id="st-meat">â€”</div><div class="stat-label">Ğ¼ÑÑĞ¾</div></div>
  </div>

  <div class="source-banner">
    <span>ğŸ“¡ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ· <strong>Netlify Forms</strong> â€” Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ñ‹ ÑĞ¾ Ğ²ÑĞµÑ… ÑƒÑÑ‚Ñ€Ğ¾Ğ¹ÑÑ‚Ğ² Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸</span>
    <a href="https://app.netlify.com" target="_blank">ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Netlify â†’</a>
  </div>

  <div class="controls-bar">
    <input class="search-box" type="text" id="searchInput" placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸â€¦" oninput="renderTable()">
    <button class="filter-btn active" onclick="setFilter('all',this)">Ğ’ÑĞµ</button>
    <button class="filter-btn" onclick="setFilter('yes',this)">ĞŸÑ€Ğ¸Ğ´ÑƒÑ‚</button>
    <button class="filter-btn" onclick="setFilter('no',this)">ĞĞµ ÑĞ¼Ğ¾Ğ³ÑƒÑ‚</button>
  </div>

  <div class="table-wrap">
    <table class="guests-table">
      <thead><tr>
        <th>#</th><th>Ğ˜Ğ¼Ñ</th><th>ĞŸÑ€Ğ¸Ğ´Ñ‘Ñ‚?</th><th>Ğ“Ğ¾Ñ€ÑÑ‡ĞµĞµ</th><th>ĞĞ°Ğ¿Ğ¸Ñ‚ĞºĞ¸</th><th>Ğ”Ğ°Ñ‚Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°</th><th></th>
      </tr></thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="mobile-cards" id="mobileCards"></div>
    <div class="empty-state" id="emptyState" style="display:none">
      <svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0H4"/></svg>
      <p id="emptyMsg">ĞÑ‚Ğ²ĞµÑ‚Ğ¾Ğ² Ğ¿Ğ¾ĞºĞ° Ğ½ĞµÑ‚</p>
    </div>
  </div>
</div>

<!-- â•â• CONFIRM DIALOG â•â• -->
<div class="overlay" id="confirmOverlay">
  <div class="confirm-box">
    <div class="confirm-icon" id="cIcon">ğŸ—‘</div>
    <div class="confirm-title" id="cTitle"></div>
    <div class="confirm-msg" id="cMsg"></div>
    <div class="confirm-btns">
      <button class="cbtn-cancel" onclick="closeConfirm()">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="cbtn-ok" id="cOkBtn">Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ADMIN_PASSWORD = 'wedding2026'; // â† ÑĞ¼ĞµĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ
const FORM_NAME      = 'wedding-guests'; // Ğ¸Ğ¼Ñ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ (Ğ°Ñ‚Ñ€Ğ¸Ğ±ÑƒÑ‚ name= Ğ² index.html)
const STORE_TOKEN    = 'nf_token';
const STORE_SITE     = 'nf_site';
const STORE_FORM     = 'nf_form_id';

let allGuests    = [];
let currentFilter = 'all';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ğ­ĞšĞ ĞĞĞ«
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function show(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function tryLogin() {
  const val = document.getElementById('pwd').value;
  if (val === ADMIN_PASSWORD) {
    sessionStorage.setItem('auth', '1');
    document.getElementById('loginErr').classList.remove('show');
    afterLogin();
  } else {
    document.getElementById('loginErr').classList.add('show');
    document.getElementById('pwd').style.borderColor = '#c0392b';
  }
}
document.getElementById('pwd').addEventListener('keydown', e => { if (e.key === 'Enter') tryLogin(); });

function logout() {
  sessionStorage.removeItem('auth');
  show('screenLogin');
}

function afterLogin() {
  const token  = localStorage.getItem(STORE_TOKEN);
  const siteId = localStorage.getItem(STORE_SITE);
  if (token && siteId) {
    show('screenApp');
    loadGuests();
  } else {
    show('screenSetup');
  }
}

if (sessionStorage.getItem('auth') === '1') afterLogin();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETUP â€” Ğ²Ğ²Ğ¾Ğ´ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¸ site ID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSetup() {
  const token  = document.getElementById('setupToken').value.trim();
  const siteId = document.getElementById('setupSiteId').value.trim();
  const err    = document.getElementById('setupErr');
  const btn    = document.getElementById('setupBtn');

  if (!token || !siteId) {
    err.textContent = 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ° Ğ¿Ğ¾Ğ»Ñ';
    err.classList.add('show');
    return;
  }

  btn.disabled = true;
  btn.textContent = 'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼â€¦';
  err.classList.remove('show');

  // Ğ˜Ñ‰ĞµĞ¼ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ğ¿Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ¸
  try {
    const res = await netlifyFetch(`/api/v1/sites/${siteId}/forms`, token);
    if (!res.ok) throw new Error(`ĞÑˆĞ¸Ğ±ĞºĞ° ${res.status}: Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Site ID Ğ¸ Ñ‚Ğ¾ĞºĞµĞ½`);
    const forms = await res.json();
    const form  = forms.find(f => f.name === FORM_NAME);
    if (!form) throw new Error(`Ğ¤Ğ¾Ñ€Ğ¼Ğ° "${FORM_NAME}" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°. Ğ£Ğ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, Ñ‡Ñ‚Ğ¾ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ¸Ğ½ Ğ³Ğ¾ÑÑ‚ÑŒ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ğ» Ğ°Ğ½ĞºĞµÑ‚Ñƒ.`);

    localStorage.setItem(STORE_TOKEN, token);
    localStorage.setItem(STORE_SITE,  siteId);
    localStorage.setItem(STORE_FORM,  form.id);

    show('screenApp');
    loadGuests();
  } catch(e) {
    err.textContent = e.message;
    err.classList.add('show');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ¸ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ â†’';
  }
}

function clearSetup() {
  localStorage.removeItem(STORE_TOKEN);
  localStorage.removeItem(STORE_SITE);
  localStorage.removeItem(STORE_FORM);
  show('screenSetup');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NETLIFY API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function netlifyFetch(path, token, options={}) {
  return fetch('https://api.netlify.com' + path, {
    ...options,
    headers: {
      'Authorization': 'Bearer ' + (token || localStorage.getItem(STORE_TOKEN)),
      'Content-Type': 'application/json',
      ...(options.headers || {})
    }
  });
}

async function loadGuests() {
  setLoading(true);
  const formId = localStorage.getItem(STORE_FORM);
  const siteId = localStorage.getItem(STORE_SITE);

  try {
    // Ğ•ÑĞ»Ğ¸ form_id ĞµÑ‰Ñ‘ Ğ½Ğµ Ğ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½ â€” Ğ½Ğ°Ğ¹Ñ‚Ğ¸
    let fid = formId;
    if (!fid) {
      const r = await netlifyFetch(`/api/v1/sites/${siteId}/forms`);
      const forms = await r.json();
      const form = forms.find(f => f.name === FORM_NAME);
      if (!form) throw new Error('Ğ¤Ğ¾Ñ€Ğ¼Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°');
      fid = form.id;
      localStorage.setItem(STORE_FORM, fid);
    }

    // Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑĞ°Ğ±Ğ¼Ğ¸ÑˆĞµĞ½Ñ‹ (Ğ´Ğ¾ 1000, Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ ÑĞ²Ğ°Ğ´ÑŒĞ±Ñ‹)
    const r2 = await netlifyFetch(`/api/v1/forms/${fid}/submissions?per_page=1000`);
    if (!r2.ok) throw new Error('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' + r2.status);
    const raw = await r2.json();

    // ĞĞ¾Ñ€Ğ¼Ğ°Ğ»Ğ¸Ğ·ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»Ñ (Netlify Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² submission.data)
    allGuests = raw.map(s => ({
      id:         s.id,
      ts:         new Date(s.created_at).toLocaleString('ru'),
      name:       s.data?.name       || '',
      attendance: s.data?.attendance || '',
      food:       s.data?.food       || '',
      drinks:     Array.isArray(s.data?.drinks)
                    ? s.data.drinks.join(', ')
                    : (s.data?.drinks || '')
    }));

    renderStats();
    renderTable();
  } catch(e) {
    showEmpty('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸: ' + e.message);
  } finally {
    setLoading(false);
  }
}

async function deleteGuest(netlifyId, name) {
  try {
    const r = await netlifyFetch(`/api/v1/submissions/${netlifyId}`, null, { method: 'DELETE' });
    if (!r.ok) throw new Error('ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ: ' + r.status);
    allGuests = allGuests.filter(g => g.id !== netlifyId);
    renderStats();
    renderTable();
  } catch(e) {
    alert('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ: ' + e.message);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStats() {
  const yes  = allGuests.filter(g => g.attendance.includes('Ğ”Ğ°')).length;
  const no   = allGuests.filter(g => g.attendance.includes('Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ñƒ')).length;
  document.getElementById('st-total').textContent = allGuests.length;
  document.getElementById('st-yes').textContent   = yes;
  document.getElementById('st-no').textContent    = no;
  document.getElementById('st-bird').textContent  = allGuests.filter(g => g.food === 'ĞŸÑ‚Ğ¸Ñ†Ğ°').length;
  document.getElementById('st-meat').textContent  = allGuests.filter(g => g.food === 'ĞœÑÑĞ¾').length;
}

function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderTable();
}

function renderTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const data = allGuests.filter(g => {
    const ms = !q || g.name.toLowerCase().includes(q);
    const mf = currentFilter === 'all'
      || (currentFilter === 'yes' && g.attendance.includes('Ğ”Ğ°'))
      || (currentFilter === 'no'  && g.attendance.includes('Ğ½Ğµ ÑĞ¼Ğ¾Ğ³Ñƒ'));
    return ms && mf;
  });

  const tbody  = document.getElementById('tableBody');
  const mcards = document.getElementById('mobileCards');
  tbody.innerHTML = mcards.innerHTML = '';

  if (!data.length) { showEmpty('ĞĞ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾'); return; }
  document.getElementById('emptyState').style.display = 'none';

  data.forEach((g, i) => {
    const isYes = g.attendance.includes('Ğ”Ğ°');
    const cls   = isYes ? 'chip-yes' : 'chip-no';
    const lbl   = isYes ? 'âœ“ ĞŸÑ€Ğ¸Ğ´Ñ‘Ñ‚' : 'âœ— ĞĞµ ÑĞ¼Ğ¾Ğ¶ĞµÑ‚';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="color:#aaa;font-size:13px;width:28px">${i+1}</td>
      <td class="td-name">${esc(g.name)}</td>
      <td><span class="chip ${cls}">${lbl}</span></td>
      <td>${g.food ? `<span class="chip chip-food">${esc(g.food)}</span>` : '<span style="opacity:.3">â€”</span>'}</td>
      <td><div class="drinks-list">${g.drinks ? esc(g.drinks) : '<span style="opacity:.3">â€”</span>'}</div></td>
      <td class="td-ts">${esc(g.ts)}</td>
      <td><button class="btn-del" onclick="confirmDel('${g.id}','${esc(g.name)}')" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">âœ•</button></td>
    `;
    tbody.appendChild(tr);

    const card = document.createElement('div');
    card.className = 'm-card';
    card.innerHTML = `
      <button class="m-card-del" onclick="confirmDel('${g.id}','${esc(g.name)}')" title="Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ">âœ•</button>
      <div class="m-card-name">${esc(g.name)}</div>
      <div class="m-card-row"><div class="m-card-key">Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ</div><span class="chip ${cls}">${lbl}</span></div>
      ${g.food   ? `<div class="m-card-row"><div class="m-card-key">Ğ“Ğ¾Ñ€ÑÑ‡ĞµĞµ</div><span class="chip chip-food">${esc(g.food)}</span></div>` : ''}
      ${g.drinks ? `<div class="m-card-row"><div class="m-card-key">ĞĞ°Ğ¿Ğ¸Ñ‚ĞºĞ¸</div><div style="font-size:13px">${esc(g.drinks)}</div></div>` : ''}
      <div class="m-card-ts">${esc(g.ts)}</div>
    `;
    mcards.appendChild(card);
  });
}

function showEmpty(msg) {
  document.getElementById('emptyState').style.display = 'block';
  document.getElementById('emptyMsg').textContent = msg;
}

function setLoading(on) {
  document.getElementById('loadingBar').classList.toggle('show', on);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIRM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function confirmDel(id, name) {
  document.getElementById('cIcon').textContent  = 'ğŸ—‘';
  document.getElementById('cTitle').textContent = 'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ³Ğ¾ÑÑ‚Ñ?';
  document.getElementById('cMsg').innerHTML     = `Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ <strong>${esc(name)}</strong> Ğ±ÑƒĞ´ĞµÑ‚ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ° Ğ¸Ğ· Netlify Ğ±ĞµĞ·Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‚Ğ½Ğ¾.`;
  document.getElementById('cOkBtn').textContent = 'Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ';
  document.getElementById('cOkBtn').onclick = () => { deleteGuest(id, name); closeConfirm(); };
  openConfirm();
}

function openConfirm()  { document.getElementById('confirmOverlay').classList.add('open'); }
function closeConfirm() { document.getElementById('confirmOverlay').classList.remove('open'); }
document.getElementById('confirmOverlay').addEventListener('click', e => { if (e.target.id === 'confirmOverlay') closeConfirm(); });
document.addEventListener('keydown', e => { if (e.key === 'Escape') closeConfirm(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CSV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportCSV() {
  const rows = [['#','Ğ˜Ğ¼Ñ','ĞŸÑ€Ğ¸Ğ´Ñ‘Ñ‚','Ğ“Ğ¾Ñ€ÑÑ‡ĞµĞµ','ĞĞ°Ğ¿Ğ¸Ñ‚ĞºĞ¸','Ğ’Ñ€ĞµĞ¼Ñ'], ...allGuests.map((g,i) => [i+1,g.name,g.attendance,g.food,g.drinks,g.ts])];
  const csv  = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(';')).join('\n');
  const a    = Object.assign(document.createElement('a'), { href: URL.createObjectURL(new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8'})), download: `guests-${new Date().toLocaleDateString('ru')}.csv` });
  a.click();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>